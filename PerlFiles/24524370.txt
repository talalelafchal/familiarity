Replace all the spaces in content of any tag with `&amp;nbsp;`
<p><strong>Task</strong></p> <p>Replace all the spaces in content of any tag with <code>&amp;nbsp;</code>.</p> <p><strong>y.html</strong> (sample file)</p> <pre><code>&lt;p class=MsoNormal style='margin-top:1.0pt;margin-right:0cm;margin-bottom:1.0pt; margin-left:34.0pt;text-indent:-19.8pt'&gt;&lt;span lang=NL-BE style='font-size:10.0pt; font-family:Symbol;color:black;mso-ansi-language:NL-BE'&gt;·&lt;/span&gt;&lt;span class=GramE&gt;&lt;span style='font-size:7.0pt;color:black'&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;/span&gt;&lt;span style='font-size:10.0pt;font-family:Arial;color:black'&gt;Kit&lt;/span&gt;&lt;/span&gt;&lt;span style='font-size:10.0pt;font-family:Arial;color:black'&gt; &lt;/span&gt;&lt;span class=SpellE&gt;&lt;i&gt;&lt;span style='font-size:10.0pt;font-family:Arial'&gt;Strongyloides&lt;/span&gt;&lt;/i&gt;&lt;/span&gt;&lt;i&gt;&lt;span style='font-size:10.0pt;font-family:Arial'&gt; &lt;span class=SpellE&gt;ratti&lt;/span&gt;&lt;/span&gt;&lt;/i&gt;&lt;span style='font-size:10.0pt;font-family:Arial'&gt; (nr. 9450) van &lt;span class=SpellE&gt;Bordier&lt;/span&gt; Affinity Products. &lt;/span&gt;&lt;span lang=NL-BE style='font-size:10.0pt;font-family: Arial;mso-ansi-language:NL-BE'&gt;Zie bijsluiter in bijlage: CLKB_B_0306. Te bewaren bij 2 – 8 °C tot vervaldatum.&lt;/span&gt;&lt;span lang=NL-BE style='mso-ansi-language: NL-BE'&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt; </code></pre> <p><strong>What I tried</strong></p> <pre><code>#!/usr/bin/perl use strict; use warnings; use Mojo::DOM; open (my $fh, "&lt;", "y.html") or die $!; my $dom = Mojo::DOM-&gt;new(do{local $/ = undef; &lt;$fh&gt;}); $dom-&gt;find("*")-&gt;each( sub { $_-&gt;content( $_-&gt;content =~ s/\s/\&amp;nbsp;/gr ) } ); print $dom; </code></pre> <p><strong>Result from above script</strong></p> <pre><code>&lt;p class="MsoNormal" style="margin-top:1.0pt;margin-right:0cm;margin-bottom:1.0pt; margin-left:34.0pt;text-indent:-19.8pt"&gt;&lt;span&amp;nbsp;lang="nl-be"&amp;nbsp;style="font-size:10.0pt;&amp;nbsp;font-family:symbol;color:black;mso-ansi-language:nl-be"&gt;·&lt;span&amp;nbsp;class="grame"&gt;&lt;span&amp;nbsp;style="font-s ize:7.0pt;color:black"&gt; &lt;span&amp;nbsp;style="font-size:10.0pt;font-family:arial;color:black"&gt;Kit&lt;span&amp;nbsp;style="font-size:10.0pt;font-family:arial;color:black"&gt; &lt;span&amp;nbsp;class="spelle"&gt;&lt;i&gt;&lt;span&amp;nb sp;style="font-size:10.0pt;font-family:arial"&gt;Strongyloides&lt;i&gt;&lt;span&amp;nbsp;style="font-size:10.0pt;font-family:arial"&gt; &lt;span&amp;nbsp;class="spelle"&gt;ratti&lt;span&amp;nbsp;style="font-size:10.0pt;font-family:arial"&gt; (n r. 9450) van &lt;span&amp;nbsp;class="spelle"&gt;Bordier Affinity Products. &lt;span&amp;nbsp;lang="nl-be"&amp;nbsp;style="font-size:10.0pt;font-family:&amp;nbsp;arial;mso-ansi-language:nl-be"&gt;Zie bijsluiter in bijlage: CLKB_B_030 6. Te bewaren bij 2 – 8 °C tot vervaldatum.&lt;span&amp;nbsp;lang="nl-be"&amp;nbsp;style="mso-ansi-language:&amp;nbsp;nl-be"&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&amp;nbsp;lang="nl-be"&amp;nbsp;style="mso-ansi-language:&amp;nbsp;nl-be"&gt;&lt;/span&amp;nbsp;lang ="nl-be"&amp;nbsp;style="font-size:10.0pt;font-family:&amp;nbsp;arial;mso-ansi-language:nl-be"&gt;&lt;/span&amp;nbsp;class="spelle"&gt;&lt;/span&amp;nbsp;style="font-size:10.0pt;font-family:arial"&gt;&lt;/span&amp;nbsp;class="spelle"&gt;&lt;/span&amp;nb sp;style="font-size:10.0pt;font-family:arial"&gt;&lt;/i&gt;&lt;/span&amp;nbsp;style="font-size:10.0pt;font-family:arial"&gt;&lt;/i&gt;&lt;/span&amp;nbsp;class="spelle"&gt;&lt;/span&amp;nbsp;style="font-size:10.0pt;font-family:arial;color:black"&gt;&lt;/ span&amp;nbsp;style="font-size:10.0pt;font-family:arial;color:black"&gt;&lt;/span&amp;nbsp;style="font-size:7.0pt;color:black"&gt;&lt;/span&amp;nbsp;class="grame"&gt;&lt;/span&amp;nbsp;lang="nl-be"&amp;nbsp;style="font-size:10.0pt;&amp;nbsp;font-f amily:symbol;color:black;mso-ansi-language:nl-be"&gt;&lt;/p&gt; </code></pre> <p>I'm not getting the desired output, it's adding <code>&amp;nbsp;</code> in tag also (eg: <code>&lt;/span&amp;nbsp;</code>), I want that to be done only on the content.</p> <p>PS: I tried it with <code>Mojo::DOM</code>, but it's not necessary to use it, you can try any other parser if you want, still I would like to know what's wrong with my code?</p>
<p>This is a job where tokenizing the input makes it easier to work with. I therefore advise using <a href="https://metacpan.org/pod/HTML%3a%3aTokeParser" rel="nofollow"><code>HTML::TokeParser</code></a></p> <pre><code>#!/usr/bin/perl use strict; use warnings; use utf8; use HTML::TokeParser; my $data = do {local $/; &lt;DATA&gt;}; my $p = HTML::TokeParser-&gt;new(\$data); while (my $token = $p-&gt;get_token) { if ($token-&gt;[0] eq 'T') { my $text = $token-&gt;[1]; $text =~ s/ /&amp;nbsp;/g; print $text; } else { print "$token-&gt;[-1]"; } } __DATA__ &lt;html&gt; &lt;body&gt; &lt;p class=MsoNormal style='margin-top:1.0pt;margin-right:0cm;margin-bottom:1.0pt; margin-left:34.0pt;text-indent:-19.8pt'&gt;&lt;span lang=NL-BE style='font-size:10.0pt; font-family:Symbol;color:black;mso-ansi-language:NL-BE'&gt;·&lt;/span&gt;&lt;span class=GramE&gt;&lt;span style='font-size:7.0pt;color:black'&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;/span&gt;&lt;span style='font-size:10.0pt;font-family:Arial;color:black'&gt;Kit&lt;/span&gt;&lt;/span&gt;&lt;span style='font-size:10.0pt;font-family:Arial;color:black'&gt; &lt;/span&gt;&lt;span class=SpellE&gt;&lt;i&gt;&lt;span style='font-size:10.0pt;font-family:Arial'&gt;Strongyloides&lt;/span&gt;&lt;/i&gt;&lt;/span&gt;&lt;i&gt;&lt;span style='font-size:10.0pt;font-family:Arial'&gt; &lt;span class=SpellE&gt;ratti&lt;/span&gt;&lt;/span&gt;&lt;/i&gt;&lt;span style='font-size:10.0pt;font-family:Arial'&gt; (nr. 9450) van &lt;span class=SpellE&gt;Bordier&lt;/span&gt; Affinity Products. &lt;/span&gt;&lt;span lang=NL-BE style='font-size:10.0pt;font-family: Arial;mso-ansi-language:NL-BE'&gt;Zie bijsluiter in bijlage: CLKB_B_0306. Te bewaren bij 2 – 8 °C tot vervaldatum.&lt;/span&gt;&lt;span lang=NL-BE style='mso-ansi-language: NL-BE'&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt; &lt;/body&gt; &lt;/html&gt; </code></pre> <p>Outputs:</p> <pre><code>&lt;html&gt; &lt;body&gt; &lt;p class=MsoNormal style='margin-top:1.0pt;margin-right:0cm;margin-bottom:1.0pt; margin-left:34.0pt;text-indent:-19.8pt'&gt;&lt;span lang=NL-BE style='font-size:10.0pt; font-family:Symbol;color:black;mso-ansi-language:NL-BE'&gt;·&lt;/span&gt;&lt;span class=GramE&gt;&lt;span style='font-size:7.0pt;color:black'&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;/span&gt;&lt;span style='font-size:10.0pt;font-family:Arial;color:black'&gt;Kit&lt;/span&gt;&lt;/span&gt;&lt;span style='font-size:10.0pt;font-family:Arial;color:black'&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=SpellE&gt;&lt;i&gt;&lt;span style='font-size:10.0pt;font-family:Arial'&gt;Strongyloides&lt;/span&gt;&lt;/i&gt;&lt;/span&gt;&lt;i&gt;&lt;span style='font-size:10.0pt;font-family:Arial'&gt;&amp;nbsp;&lt;span class=SpellE&gt;ratti&lt;/span&gt;&lt;/span&gt;&lt;/i&gt;&lt;span style='font-size:10.0pt;font-family:Arial'&gt;&amp;nbsp;(nr.&amp;nbsp;9450)&amp;nbsp;van&amp;nbsp;&lt;span class=SpellE&gt;Bordier&lt;/span&gt; Affinity&amp;nbsp;Products.&amp;nbsp;&lt;/span&gt;&lt;span lang=NL-BE style='font-size:10.0pt;font-family: Arial;mso-ansi-language:NL-BE'&gt;Zie&amp;nbsp;bijsluiter&amp;nbsp;in&amp;nbsp;bijlage:&amp;nbsp;CLKB_B_0306.&amp;nbsp;Te bewaren&amp;nbsp;bij&amp;nbsp;2&amp;nbsp;–&amp;nbsp;8&amp;nbsp;°C&amp;nbsp;tot&amp;nbsp;vervaldatum.&lt;/span&gt;&lt;span lang=NL-BE style='mso-ansi-language: NL-BE'&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt; &lt;/body&gt; &lt;/html&gt; </code></pre>