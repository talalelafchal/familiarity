Google API OAuth2 : “invalid_grant” error when requesting token for Service Account with Perl
<p>Got the credentials for Service Account from Developer Console</p> <p>First, I converted p12 private key to PEM:</p> <pre><code>openssl pkcs12 -in &lt;private key for Service Account&gt;.p12 -out calendar.key -nocerts -nodes </code></pre> <p>Then I run:</p> <pre><code>use MIME::Base64; use Crypt::OpenSSL::RSA; use File::Slurp; my $header = encode_base64('{"alg":"RS256","typ":"JWT"}',''); my $claim = encode_base64('{ "iss":"&lt;mail for the Service Account&gt;", "scope":"https://www.googleapis.com/auth/calendar", "aud":"https://accounts.google.com/o/oauth2/token", "exp":'.(time()+3600).', "iat":'.time().' }',''); my $key = read_file('calendar.key'); my $rsa = Crypt::OpenSSL::RSA-&gt;new_private_key($key); $rsa-&gt;use_sha256_hash; $rsa-&gt;use_pkcs1_padding; my $signature = encode_base64($rsa-&gt;sign($header . '.' . $claim), ''); my $token_request = $header . '.' . $claim . '.' . $signature; print `curl -d 'grant_type=urn%3Aietf%3Aparams%3Aoauth%3Agrant-type%3Ajwt-bearer&amp;assertion=$token_request' https://accounts.google.com/o/oauth2/token`; </code></pre> <p>I get </p> <pre><code>{ "error" : "invalid_grant" } </code></pre> <p>I synchronized the system time with NTP, didn't help.</p>
<p>Change your curl command to be:</p> <pre><code>curl -H "Content-Type: application/x-www-form-urlencoded" \ -d grant_type=urn:ietf:params:oauth:grant-type:jwt-bearer \ -d assertion=$token_request \ https://accounts.google.com/oauth2/token </code></pre>
<p>Try to use BASE64URL instead of BASE64. JWT/JWS/JWE specifications use BASE64URL.</p> <pre><code>MIME::Base64 ---&gt; MIME::Base64::URLSafe encode_base64 ---&gt; urlsafe_b64encode </code></pre>
<p>I don't know why, but the problem was with <code>curl</code>.</p> <p>I replaced it by <a href="https://metacpan.org/pod/WWW%3a%3aMechanize" rel="nofollow"><code>WWW::Mechanize</code></a>:</p> <pre><code>my $mech = WWW::Mechanize-&gt;new( autocheck =&gt; 1 ); $mech-&gt;post('https://accounts.google.com/o/oauth2/token', 'Content-Type' =&gt; 'application/x-www-form-urlencoded', 'Content' =&gt; [ 'grant_type' =&gt; 'urn:ietf:params:oauth:grant-type:jwt-bearer', 'assertion' =&gt; $token_request, ], ); </code></pre> <p>and it works.</p>