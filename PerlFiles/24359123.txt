How to exit a Perl program as soon as the &quot;Wide character in print at X line Y&quot; message appears?
<p>I have a Perl program that's giving me the following output:</p> <pre><code>Wide character in print at foo.pl line 139, &lt;FILE&gt; line 1. Wide character in print at foo.pl line 139, &lt;FILE&gt; line 2. Wide character in print at foo.pl line 139, &lt;FILE&gt; line 3. </code></pre> <p>As I don't want to add the <code>:utf8</code> layer, and I don't want to turn off the warnings either, I'm looking for a way to terminate the program and exit with an error code if a message like the above appears. </p> <p>As the <code>print</code> statement is the one throwing the error, I tried to use <code>or die</code> next to the <code>print</code> statement, but that didn't help. e.g.></p> <pre><code>print OUTPUT $_."\n" or die "Something wrong happened - $!"; </code></pre> <p>I guess that's not working because <code>print</code> is not really failing - it's just displaying a message. </p>
<p>You need capture Perl warnings like that:</p> <pre><code>local $SIG{__WARN__} = sub { my $mes = shift; die $mes; }; </code></pre>
<p>You can provide a custom <a href="http://perldoc.perl.org/functions/warn.html" rel="nofollow"><code>warn</code></a> handler then <code>die</code> if the message matches:</p> <pre><code>#!/usr/bin/perl use strict; use warnings; use utf8; local $SIG{__WARN__} = sub { my $msg = shift; die $msg if (index $msg, "Wide character in print") &gt; -1; warn $msg; }; warn "test warn"; print "鸡\n"; warn "won't reach"; </code></pre> <p>Produces:</p> <pre><code>test warn at foo.pl line 17. Wide character in print at foo.pl line 18. </code></pre>
<p>What you are looking for is:</p> <pre><code>use warnings FATAL =&gt; 'utf8'; </code></pre> <p>Which will cause any "Wide character" warning to be fatal, and cause the Perl process to die.</p> <p>For example:</p> <pre><code>#!/usr/bin/env perl use strict; use warnings; use utf8; use feature 'say'; for (1 .. 3) { say "παν γράμμα"; } say "=" x 80; use warnings FATAL =&gt; 'utf8'; for (1 .. 3) { say "παν γράμμα"; } </code></pre> <p>Outputs:</p> <pre><code>alex@kyon:~$ ./fatal_wide.pl Wide character in say at ./fatal_wide.pl line 9. παν γράμμα Wide character in say at ./fatal_wide.pl line 9. παν γράμμα Wide character in say at ./fatal_wide.pl line 9. παν γράμμα ================================================================================ Wide character in say at ./fatal_wide.pl line 17. </code></pre> <p>And exits with a non-zero exit status:</p> <pre><code>alex@kyon:~$ echo $? 255 </code></pre>