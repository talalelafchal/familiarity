Logging of ip address, transaction id or session id in Mojo::Log
<p>I make use of simple logging in mojolicious application. I want to extend logging by some information. This could be ip address or transaction id or session id. What I do before is writing for each log level one helper like this:</p> <pre><code>$self-&gt;helper( 'info' =&gt; sub { my $self=shift; my $msg=shift; my $ip=$self-&gt;tx-&gt;remote_address; $self-&gt;app-&gt;log-&gt;info("[$ip] $msg"); }); ... $self-&gt;info("Login failed of user $user."); </code></pre> <p>I would like to modify format of logging output so I can make use of generic log function which will add any additionally values I need and without lot of helpers for each log level. Basic call of:</p> <pre><code>$self-&gt;app-&gt;log-&gt;info("Login failed of user $user."); </code></pre> <p>should also give log entries like</p> <pre><code>[Sun Jun 8 11:09:12 2014] [info] [127.0.0.1] Login failed of user Tim. </code></pre> <p>I try do do it by change log format but anything I do is ignored.</p> <pre><code>$self-&gt;app-&gt;log-&gt;format(sub { my ($time, $level, @lines) = @_; return "[$time] [$level] [$self-&gt;tx-&gt;remote_address] @lines.\n"; }); </code></pre> <p>I know there is Log4Perl in combination with Mojolicious. But I want to keep it simple as possible.</p>
<p>I got this going pretty quick with using Mojolicious::Lite;</p> <p>To start off, shift a log to someplace you can find quickly.</p> <pre><code>use Mojo::Log; my $log = Mojo::Log-&gt;new(path =&gt; '~/log/mojo.log'); </code></pre> <p>Then try this, set the remote address variable outside of the sub first.</p> <pre><code># $r_ip = remote ip address my $r_ip = $self-&gt;tx-&gt;remote_address; $self-&gt;app-&gt;log-&gt;format(sub { my ($time, $level, @lines) = @_; return "[" . localtime(time) . "] [$level] [$r_ip] . join("\n", @lines) . "\n"; }); </code></pre> <p>The format can been seen at: <a href="http://mojolicio.us/perldoc/Mojo/Log" rel="nofollow">http://mojolicio.us/perldoc/Mojo/Log</a></p>
<p>There is a <a href="https://groups.google.com/d/msg/mojolicious/oWaU4YffyB4/s4pPrSkoAJ8J" rel="nofollow">possible to log a unique id per request/response?</a> thread on the Mojolicious mailing list, where Sebastian/sri - the author of Mojolicious - answers:</p> <blockquote> <p>Simple answer: You can't, Mojolicious is async by design and there may be thousands of concurrent requests active at any given time.</p> <p>Complex answer: If you limit your application (through the server) to handling only one request at a time and don't use any real-time web features (not that it would make much sense if you can't handle concurrent requests), you could subclass Mojo::Log to customize the message format and store a global unique id for every new request.</p> </blockquote> <p>The other (currently accepted) answer does exactly that: It removes all concurrency and uses a global variable. That'll start breaking down when you start using the real-time Mojolicious features.</p>