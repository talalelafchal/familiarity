XMLHttpRequest() Malformed Post Header HTML5 Upload
<p>I am using the following code to upload files from a phone to a web server. If I remove the ajax call and use the form only the upload works. If I use ajax the PHP or CGI scipts I use to handle the upload fail. CGI gives me a malformed post header error. </p> <pre><code> &lt;script type="text/javascript"&gt; function uploadFile() { var fd = new FormData(); var count = document.getElementById('fileUpload').files.length; for (var index = 0; index &lt; count; index ++) { var file = document.getElementById('fileUpload').files[index]; alert(file.name); } var xhr = new XMLHttpRequest(); xhr.upload.addEventListener("progress", uploadProgress, false); xhr.addEventListener("load", uploadComplete, false); xhr.addEventListener("error", uploadFailed, false); xhr.addEventListener("abort", uploadCanceled, false); xhr.open("POST", "upload.pl"); xhr.send(fd); } function uploadProgress(evt) { if (evt.lengthComputable) { var percentComplete = Math.round(evt.loaded * 100 / evt.total); document.getElementById('progress').innerHTML = percentComplete.toString() + '%'; } else { document.getElementById('progress').innerHTML = 'unable to compute'; } } function uploadComplete(evt) { alert(evt.target.responseText); } function uploadFailed(evt) { alert("There was an error attempting to upload the file."); } function uploadCanceled(evt) { alert("The upload has been canceled by the user or the browser dropped the connection."); } &lt;/script&gt; &lt;form id="form1" enctype="multipart/form-data" method="post" action="upload.pl"&gt; &lt;div&gt; &lt;label for="fileUpload"&gt;Take or Select Images&lt;/label&gt;&lt;br /&gt; &lt;input type="file" name="fileUpload" id="fileUpload" accept="image/*" capture="camera" /&gt;&lt;br /&gt; &lt;input type="text" name="email" value="" /&gt; &lt;/div&gt; &lt;div id="details"&gt;&lt;/div&gt; &lt;div&gt; &lt;input type="button" onclick="uploadFile();" value="Upload" /&gt; &lt;/div&gt; &lt;div id="progress"&gt;&lt;/div&gt; &lt;/form&gt; </code></pre>
<p>You never populated <code>fd</code> with any data! From what I read in <a href="https://developer.mozilla.org/en-US/docs/Web/Guide/Using_FormData_Objects" rel="nofollow">Using FormData Objects</a>,</p> <pre><code>var fd = new FormData(); </code></pre> <p>should be</p> <pre><code>var fd = new FormData(document.getElementById('form1')); </code></pre>