Keep getting 401'd using WWW::Pusher in Perl
<p>I'm using <a href="https://metacpan.org/pod/WWW%3a%3aPusher" rel="nofollow"><code>WWW::Pusher</code></a> in Perl to try to send a test message but I keep getting 401 for no good reason.</p> <p>Here's the <a href="https://metacpan.org/pod/HTTP%3a%3aRequest" rel="nofollow"><code>HTTP::Request</code></a> response dumped out. As you can see everything is exactly as it's supposed to be, yet I still get 401'd from an "Invalid signature" when it's really not. From <code>WWW::Pusher</code>'s source code this is the way they do it and it's all correct:</p> <pre><code>my $signature = "POST\n".$uri-&gt;path."\n".$uri-&gt;query; my $auth_signature = hmac_sha256_hex($signature, $self-&gt;{secret}); my $request = HTTP::Request-&gt;new( 'POST', $uri-&gt;as_string."&amp;auth_signature=".$auth_signature, ['Content-Type' =&gt; 'application/json'], $payload ); </code></pre> <p>RESPONSE DUMP:</p> <pre><code>$VAR1 = bless( { '_protocol' =&gt; 'HTTP/1.1', '_content' =&gt; 'Invalid signature: you should have sent HmacSHA256Hex("POST\\n/apps/77409/channels/eventname/events\\nauth_key=a07f61975e3c3f7903f3&amp;auth_timestamp=1402292321&amp;auth_version=1.0&amp;body_md5=224adf45124f9ba44f83f49cc7964687&amp;name=client rsync&amp;socket_id=", your_secret_key), but you sent "bb8628f91445ac1251e90fb1ef8f0b568cf381b5f0a77dddf3faa890f22cfb68"', '_rc' =&gt; '401', '_headers' =&gt; bless( { 'connection' =&gt; 'Close', 'client-response-num' =&gt; 1, 'client-peer' =&gt; 'x.x.x.x:80', 'content-length' =&gt; '339', 'client-date' =&gt; 'Mon, 09 Jun 2014 05:38:41 GMT', 'client-warning' =&gt; 'Missing Authenticate header', 'content-type' =&gt; 'text/html;charset=utf-8', 'server' =&gt; 'thin 1.6.1 codename Death Proof' }, 'HTTP::Headers' ), '_msg' =&gt; 'Unauthorized', '_request' =&gt; bless( { '_content' =&gt; '"test message"', '_uri' =&gt; bless( do{\(my $o = 'http://api.pusherapp.com:80/apps/77409/channels/eventname/events?auth_key=a07f61975e3c3f7903f3&amp;auth_timestamp=1402292321&amp;auth_version=1.0&amp;body_md5=224adf45124f9ba44f83f49cc7964687&amp;name=client+rsync&amp;socket_id=&amp;auth_signature=bb8628f91445ac1251e90fb1ef8f0b568cf381b5f0a77dddf3faa890f22cfb68')}, 'URI::http' ), '_headers' =&gt; bless( { 'user-agent' =&gt; 'libwww-perl/5.833', 'content-type' =&gt; 'application/json' }, 'HTTP::Headers' ), '_method' =&gt; 'POST', '_uri_canonical' =&gt; bless( do{\(my $o = 'http://api.pusherapp.com/apps/77409/channels/eventname/events?auth_key=a07f61975e3c3f7903f3&amp;auth_timestamp=1402292321&amp;auth_version=1.0&amp;body_md5=224adf45124f9ba44f83f49cc7964687&amp;name=client+rsync&amp;socket_id=&amp;auth_signature=bb8628f91445ac1251e90fb1ef8f0b568cf381b5f0a77dddf3faa890f22cfb68')}, 'URI::http' ) }, 'HTTP::Request' ) }, 'HTTP::Response' ); </code></pre>
<p>This may be significant:</p> <pre><code>'client-warning' =&gt; 'Missing Authenticate header', </code></pre> <p>Are they perhaps expecting auth info in a header instead of the query string for POST requests?</p> <p>Never mind; the docs indicate that a 401 will have information as to the problem in the content, and indeed it does:</p> <pre><code>Invalid signature: you should have sent HmacSHA256Hex("POST\\n/apps/77409/channels/eventname/events\\nauth_key=a07f61975e3c3f7903f3&amp;auth_timestamp=1402292321&amp;auth_version=1.0&amp;body_md5=224adf45124f9ba44f83f49cc7964687&amp;name=client rsync&amp;socket_id=", your_secret_key), but you sent "bb8628f91445ac1251e90fb1ef8f0b568cf381b5f0a77dddf3faa890f22cfb68" </code></pre> <p>Looks to me like where you are signing "client+rsync" you should be signing "client rsync". </p> <p>This is per their <a href="http://pusher.com/docs/rest_api#auth-signature" rel="nofollow">documentation</a>:</p> <blockquote> <p>The query parameters sorted by key, with keys converted to lowercase, then joined as in the query string. Note that the string must not be url escaped (e.g. given the keys auth_key: foo, Name: Something else, you get auth_key=foo&amp;name=Something else)</p> </blockquote>