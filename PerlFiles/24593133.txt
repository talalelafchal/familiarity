Regex gives incorrect output
<p>I am trying to parse the output of running the prsqlcache command against a SYBASE server and store output information into a table. Each column information is stored as a scalar and saved into an array after which the whole array is BCP'd in into the target table.</p> <p>As a sample, I have given two example outputs of the cached statements. In the first statement cache information, the SQL Text contains names of columns that I am trying to extract, hence when I use the code that I wrote, it breaks as there is more than one occurrence each of SSQL_DESC, ssql_name, etc.</p> <p>The easiest solution would be to remove the line containing SQL Text which I grepped to find and removed, thinking I didn't need that information. But it turns out I need that too. Is there a way to make this work with my existing logic? </p> <p><strong>input file sample</strong></p> <pre><code>Start of SSQL Hash Table at 0x0x2aacbdfdf050 Memory configured: 1024000 2k pages Memory used: 109219 2k pages Bucket# 000 address 0x0x2aacbdfdf050 SSQL_DESC 0x0x2aad268cb8b0 ssql_name *ss1530075878_1111638016ss* ssql_hashkey 0x0x42424000 ssql_id 1530075878 ssql_suid 31838 ssql_uid 1063880 ssql_dbid 14 ssql_spid 0 ssql_status 0x0x81 ssql_parallel_deg 1 ssql_isolate 1 ssql_tranmode 32 ssql_keep 0 ssql_usecnt 1 ssql_pgcount 20 ssql_optgoal allrows_oltp ssql_optlevel ase_default opt options bitmap 00809f172c6181fffb160500008009000000000000000000000000000000 SQL TEXT: select SSQL_DESC = 'addadads',ssql_name='aasass', ssql_hashkey='ssdddssddcs', ssql_id =1345, ssql_suid =4344, ssql_uid =2344, ssql_dbid=11, ssql_spid=0,ssql_status=0x024, ssql_parallel_deg=1, ssql_isolate = 1, ssql_tranmode = 32, ssql_keep = 1, ssql_usecnt =9, ssql_pgcount =8, ssql_optgoal = 'allrows', ssql_optlevel ='wee', opt = 'options', bitmap = '1235ddf3445553334' from table1 SSQL_DESC 0x0x2aad268cb8b0 ssql_name *ss1530075878_1111638016ss* ssql_hashkey 0x0x433424030 ssql_id 1443475244 ssql_suid 553 ssql_uid 1443 ssql_dbid 15 ssql_spid 1 ssql_status 0x0x22 ssql_parallel_deg 1 ssql_isolate 1 ssql_tranmode 62 ssql_keep 0 ssql_usecnt 1 ssql_pgcount 22 ssql_optgoal allrows_oltp ssql_optlevel ase_default opt options bitmap 00809f172c6181fffb160500008009000000000000000000000000000000 SQL TEXT: select column from table </code></pre> <p><strong>code snippet</strong></p> <pre><code>foreach my $line (@file){ #print $line; my $string = "SSQL_DESC"; my $string1 = "ssql_name"; my $string2 ="ssql_hashkey"; my $string3 = "ssql_suid"; my $string4 = "ssql_status"; my $string5 = "ssql_isolate"; my $string6 = "ssql_keep"; my $string7 = "ssql_optgoal"; my $string8 = "bitmap"; if ($line =~ /$string/i) { my @sentence = split ' ', $line; $sql_desc = $sentence[1]; } if ($line =~ /$string1/i) { my @sentence = split ' ', $line; $sql_name = $sentence[1]; } if ($line =~ /$string2/i) { my @sentence = split ' ', $line; $sql_hashkey = $sentence[1]; $ssql_id = $sentence[3]; print Dumper \@sentence; } if($line =~ /$string3/i){ my @sentence = split ' ', $line; $ssql_suid = $sentence[1]; $ssql_uid = $sentence[3]; $ssql_dbid = $sentence[5]; $ssql_spid = $sentence[7]; } if($line =~ /$string4/i){ my @sentence = split ' ', $line; $ssql_status = $sentence[1]; $ssql_parallel_deg = $sentence[3]; } if($line =~ /$string5/i){ my @sentence = split ' ', $line; $ssql_isolate = $sentence[1]; $ssql_tranmode = $sentence[3]; } if($line =~ /$string6/i){ my @sentence = split ' ', $line; $ssql_keep = $sentence[1]; $ssql_usecnt = $sentence[3]; $ssql_pgcount = $sentence[5]; } if($line =~ /$string7/i){ my @sentence = split ' ', $line; $ssql_optgoal = $sentence[1]; $ssql_optlevel = $sentence[3]; } if ($line =~ /$string8/i) { my @sentence = split ' ', $line; $ssql_opt = $sentence[1]; $bitmap = $sentence[3]; @array = ($sql_desc, $sql_name, $sql_hashkey, $ssql_id, $ssql_suid, $ssql_uid, $ssql_dbid, $ssql_spid, $ssql_status, $ssql_parallel_deg, $ssql_isolate, $ssql_tranmode, $ssql_keep, $ssql_usecnt, $ssql_pgcount, $ssql_optgoal, $ssql_optlevel, $ssql_opt, $bitmap); #print Dumper \@array; } } </code></pre> <p><strong>Output:</strong></p> <pre><code>$VAR1 = [ 'ssql_hashkey', '0x0x42424000', 'ssql_id', '1530075878' ]; $VAR1 = [ 'SQL', 'TEXT:', 'select', 'SSQL_DESC', '=', '\'addadads\',ssql_name=\'aasass\',', 'ssql_hashkey=\'ssdddssddcs\',', 'ssql_id', '=1345,', 'ssql_suid', '=4344,', 'ssql_uid', '=2344,', 'ssql_dbid=11,', 'ssql_spid=0,ssql_status=0x024,', 'ssql_parallel_deg=1,', 'ssql_isolate', '=', '1,', 'ssql_tranmode', '=', '32,', 'ssql_keep', '=', '1,', 'ssql_usecnt', '=9,', 'ssql_pgcount', '=8,', 'ssql_optgoal', '=', '\'allrows\',', 'ssql_optlevel', '=\'wee\',', 'opt', '=', '\'options\',', 'bitmap', '=', '\'1235ddf3445553334\'', 'from', 'table1' ]; $VAR1 = [ 'ssql_hashkey', '0x0x433424030', 'ssql_id', '1443475244' ]; </code></pre>
<p>Whenever you find yourself writing many scalar declarations all to to be used in a similar way then you should think of using a <em>hash</em> straight away. The same applies to a sequence of variables whose names are all the same except for an index number on the end: those should be an <em>array</em>.</p> <p>The nicest way to deal with this is to treat the <code>SQL TEXT</code> line as a special case. It is also useful because it is always the last line of each block, and so can serve as a trigger to dump the data found so far.</p> <p>I have used an array <code>@fields</code> to contain the names of all the fields to be extracted. It is simple to derived a regex that matches any of the field names by <code>join</code>ing them with a pipe <code>|</code> alternation operator.</p> <p>Thereafter it is only necessary to find all occurrences of any field name in each line of the file, and extract the following data field. All of this is stored in hash <code>%data</code>.</p> <p>I have hard-coded <code>ssql_opt</code> as <code>"bitmap"</code> because it always seems to be the same. If this is wrong then you must explain how to get its value out of the file. I suspect that, in fact, there may be may <code>opt</code> values, and you will have to reconsider how these are to be represented.</p> <p>I haven't rebuilt your final <code>@array</code> because it's not clear that it is anything but a debugging artifact. If you need it then it is just <code>my @array = @data{@fields}</code>.</p> <pre><code>use strict; use warnings; use 5.010; use Data::Dump; my @fields = qw/ SSQL_DESC ssql_name ssql_hashkey ssql_id ssql_suid ssql_uid ssql_dbid ssql_spid ssql_status ssql_parallel_deg ssql_isolate ssql_tranmode ssql_keep ssql_usecnt ssql_pgcount ssql_optgoal ssql_optlevel bitmap /; my $re = join '|', @fields; my %data; while (my $line = &lt;DATA&gt;) { if ( $line =~ /^(SQL TEXT):\s*(.*)/ ) { $data{$1} = $2; $data{ssql_opt} = "bitmap"; printf "%-20s =&gt; %s\n", $_, $data{$_} // '&lt;undef&gt;' for @fields; print "$1: $2\n"; print "\n"; %data = (); } else { $data{$1} = $2 while $line =~ /\b($re)\s+(\S+)/og; } } __DATA__ Start of SSQL Hash Table at 0x0x2aacbdfdf050 Memory configured: 1024000 2k pages Memory used: 109219 2k pages Bucket# 000 address 0x0x2aacbdfdf050 SSQL_DESC 0x0x2aad268cb8b0 ssql_name *ss1530075878_1111638016ss* ssql_hashkey 0x0x42424000 ssql_id 1530075878 ssql_suid 31838 ssql_uid 1063880 ssql_dbid 14 ssql_spid 0 ssql_status 0x0x81 ssql_parallel_deg 1 ssql_isolate 1 ssql_tranmode 32 ssql_keep 0 ssql_usecnt 1 ssql_pgcount 20 ssql_optgoal allrows_oltp ssql_optlevel ase_default opt options bitmap 00809f172c6181fffb160500008009000000000000000000000000000000 SQL TEXT: select SSQL_DESC = 'addadads',ssql_name='aasass', ssql_hashkey='ssdddssddcs', ssql_id =1345, ssql_suid =4344, ssql_uid =2344, ssql_dbid=11, ssql_spid=0,ssql_status=0x024, ssql_parallel_deg=1, ssql_isolate = 1, ssql_tranmode = 32, ssql_keep = 1, ssql_usecnt =9, ssql_pgcount =8, ssql_optgoal = 'allrows', ssql_optlevel ='wee', opt = 'options', bitmap = '1235ddf3445553334' from table1 SSQL_DESC 0x0x2aad268cb8b0 ssql_name *ss1530075878_1111638016ss* ssql_hashkey 0x0x433424030 ssql_id 1443475244 ssql_suid 553 ssql_uid 1443 ssql_dbid 15 ssql_spid 1 ssql_status 0x0x22 ssql_parallel_deg 1 ssql_isolate 1 ssql_tranmode 62 ssql_keep 0 ssql_usecnt 1 ssql_pgcount 22 ssql_optgoal allrows_oltp ssql_optlevel ase_default opt options bitmap 00809f172c6181fffb160500008009000000000000000000000000000000 SQL TEXT: select column from table </code></pre> <p><strong>output</strong></p> <pre><code>SSQL_DESC =&gt; 0x0x2aad268cb8b0 ssql_name =&gt; *ss1530075878_1111638016ss* ssql_hashkey =&gt; 0x0x42424000 ssql_id =&gt; 1530075878 ssql_suid =&gt; 31838 ssql_uid =&gt; 1063880 ssql_dbid =&gt; 14 ssql_spid =&gt; 0 ssql_status =&gt; 0x0x81 ssql_parallel_deg =&gt; 1 ssql_isolate =&gt; 1 ssql_tranmode =&gt; 32 ssql_keep =&gt; 0 ssql_usecnt =&gt; 1 ssql_pgcount =&gt; 20 ssql_optgoal =&gt; allrows_oltp ssql_optlevel =&gt; ase_default ssql_opt =&gt; bitmap bitmap =&gt; 00809f172c6181fffb160500008009000000000000000000000000000000 SQL TEXT: select SSQL_DESC = 'addadads',ssql_name='aasass', ssql_hashkey='ssdddssddcs', ssql_id =1345, ssql_suid =4344, ssql_uid =2344, ssql_dbid=11, ssql_spid=0,ssql_status=0x024, ssql_parallel_deg=1, ssql_isolate = 1, ssql_tranmode = 32, ssql_keep = 1, ssql_usecnt =9, ssql_pgcount =8, ssql_optgoal = 'allrows', ssql_optlevel ='wee', opt = 'options', bitmap = '1235ddf3445553334' from table1 SSQL_DESC =&gt; 0x0x2aad268cb8b0 ssql_name =&gt; *ss1530075878_1111638016ss* ssql_hashkey =&gt; 0x0x433424030 ssql_id =&gt; 1443475244 ssql_suid =&gt; 553 ssql_uid =&gt; 1443 ssql_dbid =&gt; 15 ssql_spid =&gt; 1 ssql_status =&gt; 0x0x22 ssql_parallel_deg =&gt; 1 ssql_isolate =&gt; 1 ssql_tranmode =&gt; 62 ssql_keep =&gt; 0 ssql_usecnt =&gt; 1 ssql_pgcount =&gt; 22 ssql_optgoal =&gt; allrows_oltp ssql_optlevel =&gt; ase_default ssql_opt =&gt; bitmap bitmap =&gt; 00809f172c6181fffb160500008009000000000000000000000000000000 SQL TEXT: select column from table </code></pre>