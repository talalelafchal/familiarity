Bad encoding with WWW::Mechanize in Perl
<p>I'm trying to post content through a website with <a href="https://metacpan.org/module/WWW%3aMechanize" rel="nofollow"><code>WWW:Mechanize</code></a>.</p> <p>My content seems to be UTF-8 and the website where I post it is a page that specifies ISO-8859-15 encoding on the head of the HTML page.</p> <p>The post works but I get this result</p> <p>Example of the encoding I have (in French) :</p> <pre><code>acteur majeur de l?assurance et rÃ©fÃ©rence en gestion patrimoniale, propose une approche globale pour une clientÃ¨le aisÃ©e et haut de gamme. </code></pre> <p>Here is my code</p> <pre><code>use WWW::Mechanize; use Encode; use open qw(:std :utf8); my $mech = WWW::Mechanize-&gt;new( stack_depth =&gt; 0, timeout =&gt; 10, ); mech-&gt;get($urlContentOtherWebsite); my $tree = HTML::TreeBuilder::XPath-&gt;new_from_content($mech-&gt;content); my $content = $tree-&gt;findvalue('/html/body//div[@id="content"]'); $tree-&gt;delete; mech-&gt;get($urlFormMyWebsite); $mech-&gt;form_name("formular"); # Form Post Emploi $mech-&gt;set_fields( content =&gt; $content ); $mech-&gt;submit; </code></pre> <p>have you some idea or clue to resolve my problem please?</p>
<p>From studying the code: <a href="https://metacpan.org/pod/HTML%3a%3aForm" rel="nofollow">HTML::Form</a>, which is used inside <a href="https://metacpan.org/pod/WWW%3a%3aMechanize" rel="nofollow">WWW::Mechanize</a>, uses the <code>accept-charset</code> parameter of the <code>&lt;form...&gt;</code> tag to find out which encoding to use. If there is no such parameter than it uses a default charset, which is UTF-8. You can set the acceptable charset with <code>$form-&gt;accept_charset('iso-8859-1')</code>, e.g. the following should work if I read the code correctly:</p> <pre><code>$mech-&gt;form_name("formular")-&gt;accept_charset('iso-8859-1'); $mech-&gt;set_fields(...); $mech-&gt;submit; </code></pre>
<p>You need to add</p> <pre><code>binmode STDOUT, ':encoding(utf-8)'; </code></pre> <p>at the start of your program to declare that <code>STDOUT</code> is expecting UTF-8 characters, otherwise you will see the individual bytes instead of the proper characters</p> <p>You also need to decode the input as UTF-8 using</p> <pre><code>use Encode; </code></pre> <p>followed by</p> <pre><code>decode('UTF-8', $_) </code></pre> <p>where the incoming text is in <code>$_</code>.</p> <p>Here's an example</p> <pre><code>use utf8; use strict; use warnings; use Encode; binmode STDOUT, ':encoding(utf-8)'; print decode('UTF-8', $_) for &lt;DATA&gt;; __DATA__ acteur majeur de l?assurance et rÃ©fÃ©rence en gestion patrimoniale, propose une approche globale pour une clientÃ¨le aisÃ©e et haut de gamme. </code></pre> <p><strong>output</strong></p> <pre><code>acteur majeur de l?assurance et référence en gestion patrimoniale, propose une approche globale pour une clientèle aisée et haut de gamme. </code></pre> <p>I don't quite understand <code>l?assurance</code>, but I imagine that the data has been altered somewhere between the original web site and the Stack Overflow post. As you can see, the rest of the text is correct</p>