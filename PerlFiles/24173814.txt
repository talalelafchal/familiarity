Perl Net SFTP Foreign Proxy
<p>I am trying to connect to a client machine via sftp and place files there via Perl <a href="https://metacpan.org/pod/Net%3a%3aSFTP%3a%3aForeign" rel="nofollow"><code>Net::SFTP::Foreign</code></a>. I've seen lots of examples on how to do this, but none of them involve using a <em>socks proxy</em>.</p> <p><strong>Background:</strong> For the standard <a href="https://metacpan.org/pod/Net%3a%3aFTP" rel="nofollow">Net::FTP</a> I can use the <a href="https://metacpan.org/pod/IO%3a%3aSocket%3a%3aSocks%3a%3aWrapper" rel="nofollow">IO Socket Wrapper</a>, and everything gets proxied:</p> <pre><code>use IO::Socket::Socks::Wrapper({ ProxyAddr =&gt; 'my.proxy.address', ProxyPort =&gt; 1080, SocksDebug =&gt; 1 #enable for debugging }); </code></pre> <p>However, this does not work for Net::SFTP::Foreign. So, I'm trying to come up with a work-around.</p> <pre><code>if ($sftp = Net::SFTP::Foreign-&gt;new("ftp.myserver.com", user =&gt; "ftpusername", password =&gt; "ftpuserpwd", more =&gt; [-o =&gt; 'ProxyCommand=ssh -D 1080 my.proxy.address'], )) { some code that runs when successful auth... } </code></pre> <p>...I found the above on Perl Monks, but it doesn't seem to be helping. Here's the url to Perl Monks explaining this: <a href="http://www.perlmonks.org/?node_id=938019" rel="nofollow">http://www.perlmonks.org/?node_id=938019</a></p> <p>I think the key is to use the correct ProxyCommand, but I'm not sure that this is correct.</p> <p>Does anyone know how I can send files out via sftp and through a proxy?</p>
<p>You need an utility program that knows how to talk to a SOCKS proxy. For instance <code>socat</code>.</p> <p>The first thing you need to do is to find out how to invoke that utility in order to establish the connection through the proxy to the SFTP server. It should be something like this:</p> <pre><code> socat stdio SOCKS4:proxy_server:sftp_server:22 </code></pre> <p>where <code>proxy_server</code> and <code>sftp_server</code> are the names of the proxy and the SFTP server respectively.</p> <p>You know when you are doing it right because you get the version string from the SSH server back, something similar to <code>SSH-2.0-OpenSSH_6.6.1p1 Ubuntu-2ubuntu2</code></p> <p>Then, you just have to pass the command to the Net::SFTP::Foreign constructor as follows:</p> <pre><code>$sftp=Net::SFTP::Foreign-&gt;new("ftp.myserver.com", user =&gt; "ftpusername", password =&gt; "ftpuserpwd", more =&gt; [-o=&gt;'ProxyCommand=socat stdio SOCKS4:$proxy_server:ftp.myserver.com:22']); </code></pre>