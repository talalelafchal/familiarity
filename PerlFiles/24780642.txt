Perl expect into another expect
<p>I am working with Perl and Bash to make some SSH connections.</p> <p>For now, I have this code, which is working well :</p> <pre><code>$exp-&gt;spawn("ssh -o ConnectTimeout=$connectTimeout $user\@$ip") or die ("unable to spawn \n"); @obj=$exp-&gt;expect( $commandTimeout, [ qr/[Pp]assword:\s*/ =&gt; sub { my $exp = shift; $exp-&gt;send($passwdused, "\n"); #ecriture du mot de pass routeur $exp-&gt;send("term length 0", "\n"); $exp-&gt;expect($commandTimeout2,); executeCommands(); } ], [ qr/.*Are you sure you want to continue connecting.*/ =&gt; sub #si on voit "Are you sure you want to { #continue connecting" ecrit sur le routeur my $exp = shift; #on execute la sous-fonction $exp-&gt;send("yes\n"); exp_continue; } ], [ qr/.*refused.*/ =&gt; sub { my $exp = shift; #permet de renvoyer un message print ERR_REPORT "insert into erreur(code_site,ip,operateur,cause) VALUES ('$ARGV[0]','$ARGV[1]','$ARGV[2]','Connexion ssh refusee');\n"; die ("Connexion refusee par l'hote distant\n"); #est refusee. } ], </code></pre> <p>And a lot of following case like "network unreachable" or "RSA public decrypt failed".</p> <p>But I am not checking if password is correct (which is a little embarassing because Perl continues its execution and tries to send the commands).</p> <p>Can I expect something into the <code>[ qr/ [Pp]assword: \s*/ =&gt; sub function ]</code>?</p> <p>Something like : </p> <pre><code>@obj=$exp-&gt;expect( $commandTimeout, [ qr/[Pp]assword:\s*/ =&gt; sub { @obj=$exp-&gt;expect( $commandTimeout, [ qr/.*Permission.*denied.*/ =&gt; sub { #PRINT ERROR REPORT AND DIE HERE } ]); my $exp = shift; $exp-&gt;send($passwdused, "\n"); #ecriture du mot de pass routeur $exp-&gt;send("term length 0", "\n"); $exp-&gt;expect($commandTimeout2,); executeCommands(); } ], </code></pre>