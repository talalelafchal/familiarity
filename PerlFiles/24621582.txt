Impose the environment's locale in a Perl block
<p>I have some Perl code which is executed in a context where all command line arguments, inputs and outputs are encoded in the encoding given by the <code>LC_CTYPE</code> environment variable (or more generally the <code>LC_CTYPE</code> setting determined from the environment). This is exactly what <a href="http://perldoc.perl.org/perllocale.html#The-use-locale-pragma" rel="nofollow"><code>use locale</code></a> is for, right?</p> <pre><code>$ echo àé | perl -e 'use locale; print uc &lt;&gt;' ÀÉ </code></pre> <p>This works in unibyte locales such as Latin-1, but not in UTF-8, where this program outputs <code>àé</code> on my Debian wheezy machine.</p> <p><code>perl -CLADS -e 'use locale; print uc &lt;&gt;'</code> seems to do the right thing in unibyte locales and UTF-8, at least according to my understanding of the <a href="http://perldoc.perl.org/perlrun.html#*-C-%5b_number%2flist_%5d*" rel="nofollow">documentation of <code>-C</code></a>. I don't understand how I'm supposed to deduce that from the <a href="http://perldoc.perl.org/perllocale.html#Unicode-and-UTF-8" rel="nofollow"><code>perllocale</code> documentation</a> though, nor what would happen in multibyte locales other than UTF-8.</p> <p>Furthermore I actually don't want to run the whole program in this mode, only one code block. In fact <strong>I can't pass parameters to the Perl interpreter</strong>, I can only pass a string to a Perl script which calls <code>eval</code> on that string. <code>use locale</code>'s local scope would be just fine, but how do I activate <code>-C</code> from within?</p> <blockquote> <p>The read-only magic variable <code>${^UNICODE}</code> </p> </blockquote> <p>… so not that then.</p> <p>How do I run a snippet of Perl code in a mode where all strings (including <code>@ARGV</code> and file input/output) are interpreted according to the locale indicated by the environment?</p>
<p>It seems like <a href="http://perldoc.perl.org/perlrun.html#*-C-[_number/list_]*" rel="nofollow">perlrun</a> explains that -C is a combination of <a href="http://perldoc.perl.org/functions/binmode.html" rel="nofollow">binmode</a> and <a href="http://perldoc.perl.org/open.html" rel="nofollow">use open</a>;, so this will probably work (on *nix)</p> <p>update: decoding @ARGV with a little help from open.pm :)</p> <pre><code>{ use Encode(); require encoding; local @ARGV = @ARGV ; if( my $locale_encoding = encoding::_get_locale_encoding() ){ $locale_encoding = ":encoding($locale_encoding)"; @ARGV = map { Encode::decode($locale_encoding, $_ ) } @ARGV; } use open ':locale'; use locale; ... } </code></pre>