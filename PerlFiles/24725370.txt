Error using keys on a hash
<p>I have the following code:</p> <pre><code>my $xmlrpc = XML::RPC-&gt;new('http://api.opensubtitles.org/xml-rpc'); my $result = $xmlrpc-&gt;call('SearchSubtitles', $token, @args); &amp;lp ("Number of subtitle files found:".keys $result-&gt;{data}); my $count=0; mkdir "./Subs"; foreach my $key ( keys $result-&gt;{data} ) { </code></pre> <p>The compilation fails with the error:</p> <p><code>Type of argument to keys on reference must be unblessed hashref or arrayref at /root/subtitlegetter/getsubs.pl line 210.</code></p> <p>on both lines containing the <code>keys</code> statement. </p> <p>$result looks like this:</p> <pre><code>$result = { 'seconds' =&gt; '0.014', 'status' =&gt; '200 OK', 'data' =&gt; [ { 'SubFeatured' =&gt; '0', 'SubHearingImpaired' =&gt; '0', 'SubAuthorComment' =&gt; undef, 'SubDownloadLink' =&gt; 'http://dl.opensubtitles.org/en/download/filead/src-api/vrf-cc714a2b91/1951829762.gz', 'MovieNameEng' =&gt; undef, 'SubDownloadsCnt' =&gt; '2225', 'MovieName' =&gt; '"24" Day 4: 7:00 a.m.-8:00 a.m.', 'LanguageName' =&gt; 'English', 'MovieFPS' =&gt; '25.000', 'SeriesIMDBParent' =&gt; '285331', 'MovieHash' =&gt; '9dfc670867516a39', 'SeriesEpisode' =&gt; '1', 'UserNickName' =&gt; 'dvkempen', 'MovieYear' =&gt; '2005', 'SubSize' =&gt; '41095', 'MovieKind' =&gt; 'episode', 'IDSubMovieFile' =&gt; '125384', 'ZipDownloadLink' =&gt; 'http://dl.opensubtitles.org/en/download/subad/src-api/vrf-b48cd22d58/3253187', 'SubBad' =&gt; '0', 'ISO639' =&gt; 'en', 'IDSubtitle' =&gt; '3253187', 'MovieReleaseName' =&gt; '24.S04E01.WS.DVDRip.XviD-MEDiEVAL', 'MatchedBy' =&gt; 'moviehash', 'MovieTimeMS' =&gt; '2474000', 'UserID' =&gt; '1019339', 'SubFormat' =&gt; 'srt', 'MovieByteSize' =&gt; '366661632', 'SubRating' =&gt; '0.0', 'SubComments' =&gt; '0', 'SubActualCD' =&gt; '1', 'SubHash' =&gt; 'ab8ad6d19af1579361929b3f71d61b60', 'UserRank' =&gt; 'silver member', 'IDSubtitleFile' =&gt; '1951829762', 'SubSumCD' =&gt; '1', 'SubFileName' =&gt; '24.S04E01.WS.DVDRip.XviD-MEDiEVAL.srt', 'SubAddDate' =&gt; '2008-02-24 20:44:01', 'IDMovieImdb' =&gt; '502251', 'SubtitlesLink' =&gt; 'http://www.opensubtitles.org/en/subtitles/3253187/24-day-4-7-00-a-m-8-00-a-m-en', 'IDMovie' =&gt; '73012', 'SeriesSeason' =&gt; '4', 'SubHD' =&gt; '0', 'SubLanguageID' =&gt; 'eng', 'MovieImdbRating' =&gt; '8.5' }, { 'SubFeatured' =&gt; '0', 'SubHearingImpaired' =&gt; '0', 'SubAuthorComment' =&gt; undef, 'SubDownloadLink' =&gt; 'http://dl.opensubtitles.org/en/download/filead/src-api/vrf-d165613c14/1951854096.gz', 'MovieNameEng' =&gt; undef, 'SubDownloadsCnt' =&gt; '4521', 'MovieName' =&gt; '"24" Day 4: 7:00 a.m.-8:00 a.m.', 'LanguageName' =&gt; 'English', 'MovieFPS' =&gt; '25.000', 'SeriesIMDBParent' =&gt; '285331', 'MovieHash' =&gt; '9dfc670867516a39', 'SeriesEpisode' =&gt; '1', 'UserNickName' =&gt; 'mephistogrigo', 'MovieYear' =&gt; '2005', 'SubSize' =&gt; '40794', 'MovieKind' =&gt; 'episode', 'IDSubMovieFile' =&gt; '144086', 'ZipDownloadLink' =&gt; 'http://dl.opensubtitles.org/en/download/subad/src-api/vrf-18f9de1a19/4380524', 'SubBad' =&gt; '0', 'ISO639' =&gt; 'en', 'IDSubtitle' =&gt; '4380524', 'MovieReleaseName' =&gt; '24.Season.4.DVDRip.XviD-MEDiEVAL', 'MatchedBy' =&gt; 'moviehash', 'MovieTimeMS' =&gt; '2474000', 'UserID' =&gt; '446711', 'SubFormat' =&gt; 'srt', 'MovieByteSize' =&gt; '366661632', 'SubRating' =&gt; '0.0', 'SubComments' =&gt; '0', 'SubActualCD' =&gt; '1', 'SubHash' =&gt; '4d9d67b580efe4b6378d3cb34b4d2a75', 'UserRank' =&gt; 'gold member', 'IDSubtitleFile' =&gt; '1951854096', 'SubSumCD' =&gt; '1', 'SubFileName' =&gt; '24.4x01.Day.4.07am-08am.DVDRip.XviD.iNTERNAL-MEDiEVAL.EN.srt', 'SubAddDate' =&gt; '2008-04-13 14:23:34', 'IDMovieImdb' =&gt; '502251', 'SubtitlesLink' =&gt; 'http://www.opensubtitles.org/en/subtitles/4380524/24-day-4-7-00-a-m-8-00-a-m-en', 'IDMovie' =&gt; '73012', 'SeriesSeason' =&gt; '4', 'SubHD' =&gt; '0', 'SubLanguageID' =&gt; 'eng', 'MovieImdbRating' =&gt; '8.5' }, { 'SubFeatured' =&gt; '0', 'SubHearingImpaired' =&gt; '0', 'SubAuthorComment' =&gt; undef, 'SubDownloadLink' =&gt; 'http://dl.opensubtitles.org/en/download/filead/src-api/vrf-d383210797/138228.gz', 'MovieNameEng' =&gt; undef, 'SubDownloadsCnt' =&gt; '582', 'MovieName' =&gt; '"24" Day 4: 7:00 a.m.-8:00 a.m.', 'LanguageName' =&gt; 'English', 'MovieFPS' =&gt; '25.000', 'SeriesIMDBParent' =&gt; '285331', 'MovieHash' =&gt; '9dfc670867516a39', 'SeriesEpisode' =&gt; '1', 'UserNickName' =&gt; 'wr975 (a)', 'MovieYear' =&gt; '2005', 'SubSize' =&gt; '41175', 'MovieKind' =&gt; 'episode', 'IDSubMovieFile' =&gt; '2004768', 'ZipDownloadLink' =&gt; 'http://dl.opensubtitles.org/en/download/subad/src-api/vrf-b7f71cab8b/4292367', 'SubBad' =&gt; '0', 'ISO639' =&gt; 'en', 'IDSubtitle' =&gt; '4292367', 'MovieReleaseName' =&gt; '24 - Season 4 - E01-08', 'MatchedBy' =&gt; 'moviehash', 'MovieTimeMS' =&gt; '0', 'UserID' =&gt; '48281', 'SubFormat' =&gt; 'srt', 'MovieByteSize' =&gt; '366661632', 'SubRating' =&gt; '0.0', 'SubComments' =&gt; '0', 'SubActualCD' =&gt; '1', 'SubHash' =&gt; 'b6c8e5422afbb6d748040c5d401445e3', 'UserRank' =&gt; 'bronze member', 'IDSubtitleFile' =&gt; '138228', 'SubSumCD' =&gt; '1', 'SubFileName' =&gt; '24.401-med.srt', 'SubAddDate' =&gt; '2005-08-23 00:00:00', 'IDMovieImdb' =&gt; '502251', 'SubtitlesLink' =&gt; 'http://www.opensubtitles.org/en/subtitles/4292367/24-day-4-7-00-a-m-8-00-a-m-en', 'IDMovie' =&gt; '73012', 'SeriesSeason' =&gt; '4', 'SubHD' =&gt; '0', 'SubLanguageID' =&gt; 'eng', 'MovieImdbRating' =&gt; '8.5' }, { 'SubFeatured' =&gt; '0', 'SubHearingImpaired' =&gt; '0', 'SubAuthorComment' =&gt; undef, 'SubDownloadLink' =&gt; 'http://dl.opensubtitles.org/en/download/filead/src-api/vrf-d596b9fa4f/1952794930.gz', 'MovieNameEng' =&gt; undef, 'SubDownloadsCnt' =&gt; '772', 'MovieName' =&gt; '"24" Day 4: 7:00 a.m.-8:00 a.m.', 'LanguageName' =&gt; 'English', 'MovieFPS' =&gt; '25.000', 'SeriesIMDBParent' =&gt; '285331', 'MovieHash' =&gt; '9dfc670867516a39', 'SeriesEpisode' =&gt; '1', 'UserNickName' =&gt; undef, 'MovieYear' =&gt; '2005', 'SubSize' =&gt; '41307', 'MovieKind' =&gt; 'episode', 'IDSubMovieFile' =&gt; '2587404', 'ZipDownloadLink' =&gt; 'http://dl.opensubtitles.org/en/download/subad/src-api/vrf-627cac3bd1/4119493', 'SubBad' =&gt; '0', 'ISO639' =&gt; 'en', 'IDSubtitle' =&gt; '4119493', 'MovieReleaseName' =&gt; 'S04E01 iNTERNAL WS DVDRip XviD MEDiEVAL', 'MatchedBy' =&gt; 'moviehash', 'MovieTimeMS' =&gt; '0', 'UserID' =&gt; '0', 'SubFormat' =&gt; 'srt', 'MovieByteSize' =&gt; '366661632', 'SubRating' =&gt; '0.0', 'SubComments' =&gt; '0', 'SubActualCD' =&gt; '1', 'SubHash' =&gt; '295dfd2ab8ded0c6d14ed6555796f9d0', 'UserRank' =&gt; undef, 'IDSubtitleFile' =&gt; '1952794930', 'SubSumCD' =&gt; '1', 'SubFileName' =&gt; '24.S04E01.iNTERNAL.WS.DVDRip.XviD-MEDiEVAL_(ENGLISH)_DJJ.HOME.SAPO.PT.srt', 'SubAddDate' =&gt; '2011-03-01 22:37:54', 'IDMovieImdb' =&gt; '502251', 'SubtitlesLink' =&gt; 'http://www.opensubtitles.org/en/subtitles/4119493/24-day-4-7-00-a-m-8-00-a-m-en', 'IDMovie' =&gt; '73012', 'SeriesSeason' =&gt; '4', 'SubHD' =&gt; '0', 'SubLanguageID' =&gt; 'eng', 'MovieImdbRating' =&gt; '8.5' } ] }; </code></pre> <p>I find it hard to wrap my head around keys, coming from a programming language that had nothing like hashes. Could you kindly let me know what's wrong with the code?</p> <p>I should probably mention that though I've used strict and warnings, the same code compiles fine on Activestate perl 5.16.3 running in Windows, while it fails in perl 5.14.2 running on Debian. </p> <p>Edit: I've updated the content of $result according to data from Dumper.</p>
<p>The <code>keys</code> function expects a valid hash (or array, in 5.12 or later) as its argument. In 5.14 an experimental feature was introduced where several such array/hash functions (including <code>keys</code>, <code>push</code>, and others) will implicitly attempt to dereference a scalar expression, which would allow you to do something like this:</p> <pre><code>my $hash_ref = { foo =&gt; 1 }; print keys $hash_ref; </code></pre> <p>Rather than explicitly dereferencing:</p> <pre><code>my $hash_ref = { foo =&gt; 1 }; print keys %{ $hash_ref }; </code></pre> <p>However this feature is considered highly experimental* and is likely to be removed in future versions. A valid use of it (such as the example above) will produce a warning:</p> <pre><code>keys on reference is experimental at ... line ... </code></pre> <p>And an invalid use will produce the error you're getting:</p> <pre><code>my $foo = "This is not a hash ref"; print keys $foo; </code></pre> <p><code>Type of argument to keys on reference must be unblessed hashref or arrayref at -e line 1.</code></p> <p>*Experimental has an official meaning in regards to Perl features. Any feature flagged as experimental is prone to removal and/or backwards-compatibility-breaking changes without further warning.</p> <p>The solution to your problem is to simply not use <code>keys</code> on a scalar expression. This means you need to dereference your data structure accesses appropriately so the argument to <code>keys</code> is an array or hash variable. If I'm not misinterpreting the way you wrote your structure, the syntax would be something like:</p> <pre><code>foreach my $key (keys %{ $result-&gt;{data} }) { ... } </code></pre>
<p>I would advise you to not use <a href="http://perldoc.perl.org/functions/keys.html" rel="nofollow"><code>keys</code></a> on a scalar or an array. Perl the perldoc (emphasis mine):</p> <blockquote> <p>Starting with Perl 5.14, <code>keys</code> can take a scalar <code>EXPR</code>, which must contain a reference to an unblessed hash or array. The argument will be dereferenced automatically. <em>This aspect of <code>keys</code> is considered highly experimental.</em> The exact behaviour may change in a future version of Perl.</p> <pre><code> for (keys $hashref) { ... } for (keys $obj-&gt;get_arrayref) { ... } </code></pre> </blockquote> <p>Instead, just use it on a hash, like so:</p> <pre><code>foreach my $key ( keys %{$result-&gt;{data}[0]} ) { </code></pre>