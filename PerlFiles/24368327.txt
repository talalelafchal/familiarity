perl error when passing DBI-&gt;execute values for IN clause
<p>I have a query to calculate objects that are within a certain radius of a point based on a document here: <a href="http://www.plumislandmedia.net/mysql/haversine-mysql-nearest-loc/" rel="nofollow">http://www.plumislandmedia.net/mysql/haversine-mysql-nearest-loc/</a></p> <p>It works very nicely however I want to only search for those objects that are of a particular type, and this is causing a problem;</p> <p>The code looks like this:</p> <pre><code>my $sql = "SELECT * FROM ( SELECT b.*, pr.postcode, pr.prize, pr.title, pr.collection, pr.redeemed, pr.delivery, pr.archived, bt.category, p.radius, p.distance_unit * DEGREES(ACOS(COS(RADIANS(p.latpoint)) * COS(RADIANS(b.lat)) * COS(RADIANS(p.longpoint - b.lng)) + SIN(RADIANS(p.latpoint)) * SIN(RADIANS(b.lat)))) AS distance FROM bubbles AS b, bubble_prizes AS pr, bubble_types AS bt JOIN ( /* these are the query parameters */ SELECT ? AS latpoint, ? AS longpoint, ? AS radius, ? AS distance_unit ) AS p WHERE b.lat BETWEEN p.latpoint - (p.radius / p.distance_unit) AND p.latpoint + (p.radius / p.distance_unit) AND b.lng BETWEEN p.longpoint - (p.radius / (p.distance_unit * COS(RADIANS(p.latpoint)))) AND p.longpoint + (p.radius / (p.distance_unit * COS(RADIANS(p.latpoint)))) AND pr.bubble = b.id AND b.type IN ? AND b.type = bt.type ) AS d WHERE distance &lt;= radius ORDER BY distance"; </code></pre> <p>I then do</p> <pre><code>my $points = $y-&gt;dbh-&gt;prepare($sql); $results = $points-&gt;execute($lat, $lng, $rad, $units, '(type1, type2)'); </code></pre> <p>where '(type1, type2)' should be passed to </p> <pre><code>b.type IN ? </code></pre> <p>(which is near the bottom of the SQL).</p> <p>I've tried every way that I can think of to escape this string so that it works (including lots of ways that are clearly insane but I'm getting desperate) inc</p> <pre><code>'(type1, type2)' '\(\'type1\', \'type2\'\)' '(\'type1\', \'type2\')' "('type1', 'type2')" </code></pre> <p>etc (I've tried so many things I can't even remember them all.)</p> <p>No matter what I try I get an SQL error of the form</p> <pre><code>DBD::mysql::st execute failed: You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near ''(type1, type2)' AND b.type = bt.type ) AS d WHERE distance &lt;= radius' </code></pre> <p>Depending on how I've tried to escape the string, the error message is slightly different but always relating to the same part of the sql.</p> <p>I'm now thinking that escaping isn't my problem and I'm missing something about execute. If I run the code in the DB it works fine with a normal IN statement i.e. b.type IN ('type1', 'type2') works fine.</p> <p>Can someone enlighten me? How am I supposed to do this?</p> <p>Thanks</p>
<p>You will need to use placeholders within the <code>IN (...)</code> statement. The entire point of <code>execute()</code> is to avoid SQL injection, and you're basically attempting to inject SQL there. You can make a dynamic list of placeholders like so:</p> <pre><code>my @types = qw(type1 type2); my $placeholders = join ", ", ("?") x @types; my $sql = "... b.typeID IN ($placeholders) ..."; my $points = $y-&gt;dbh-&gt;prepare($sql); $results = $points-&gt;execute($lat, $lng, $rad, $units, @types); </code></pre>