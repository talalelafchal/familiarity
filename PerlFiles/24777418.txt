Websocket and Perl CGI
<p>I am bit new in CGI programming, and I trying to make an online chat API but face not few troubles: </p> <p>I was looking online for solution and found Websocket for client (js) and HTTP::Daemon for perl, but I have no idea where to start to make the server listen for the connections from the browser. </p> <p>Here is my JavaScript code: </p> <pre><code>ws = new WebSocket('ws://www.crazygao.com:3000'); // test ws.onopen = function() { alert('Connection is established!'); // test }; ws.onclose = function() { alert('Connection is closed'); }; ws.onmessage = function(e) { var message = e.data; //alert('Got new message: ' + message); }; ws.onerror = function(e) { //var message = e.data; alert('Error: ' + e); }; </code></pre> <p>Here is my Perl script test code: </p> <pre><code>use HTTP::Daemon; use HTTP::Status; my $d = HTTP::Daemon-&gt;new( LocalAddr =&gt; 'www.crazygao.com', LocalPort =&gt; 3000 ) || die; print "Please contact me at: &lt;URL:", $d-&gt;url, "&gt;\n"; while(my $c = $d-&gt;accept) { $c-&gt;send_response("1"); # test while (my $r = $c-&gt;get_request) { if ($r-&gt;method eq 'GET') { $c-&gt;send_response("..."); } } $c-&gt;close; undef($c); } </code></pre> <p>When the page loads, the connection closing immediately, and in Chrome console window I see the following error: WebSocket connection to 'ws://198.38.89.14:3000/' failed: Error in connection establishment: net::ERR_CONNECTION_REFUSED </p> <p>I run the perl script manually (using simple call to <a href="http://example.com/cgi-bin/xxx.cgi" rel="nofollow">http://example.com/cgi-bin/xxx.cgi</a>) and then when I refresh the page I get: WebSocket connection to 'ws://198.38.89.14:3000/' failed: Error during WebSocket handshake: Unexpected response code: 200 </p> <p>I understand that the server normally returns 200 when OK, but Websocket is waiting for 101 code as "OK". </p> <p>My question is, if so, how can I achieve this? </p>
<p>I know this is old and I got here because I was looking for an answer myself. I ended up finding the answer myself by using Net::WebSocket::Server.</p> <p><a href="http://search.cpan.org/~topaz/Net-WebSocket-Server-0.003004/lib/Net/WebSocket/Server.pm" rel="nofollow">http://search.cpan.org/~topaz/Net-WebSocket-Server-0.003004/lib/Net/WebSocket/Server.pm</a> for more details on how to use the module and example.</p> <p>Basically, you'll have this perl code to match your javascript (copied and modified from the CPAN page of Net::WebSocket::Server):</p> <pre><code>use Net::WebSocket::Server; my $origin = 'http://www.crazygao.com'; Net::WebSocket::Server-&gt;new( listen =&gt; 3000, on_connect =&gt; sub { my ($serv, $conn) = @_; $conn-&gt;on( handshake =&gt; sub { my ($conn, $handshake) = @_; $conn-&gt;disconnect() unless $handshake-&gt;req-&gt;origin eq $origin; }, utf8 =&gt; sub { my ($conn, $msg) = @_; $_-&gt;send_utf8($msg) for $conn-&gt;server-&gt;connections; }, binary =&gt; sub { my ($conn, $msg) = @_; $_-&gt;send_binary($msg) for $conn-&gt;server-&gt;connections; }, ); }, )-&gt;start; </code></pre>