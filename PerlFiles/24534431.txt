How to make perl lock a file with non-blocking mode in NFS
<p>fcntl in perl can lock in NFS, The default mode is blocking mode. How to make it non-blocking mode? I tried the following code, but it does not work</p> <pre><code>sub lock_file { my ($lock_file, $block) = @_; return unless defined $lock_file; my $LOCKFH; if (file_exist($lock_file)) { sysopen($LOCKFH, "$lock_file", O_RDWR) || return undef; } else { sysopen($LOCKFH, "$lock_file", O_RDWR|O_CREAT|O_EXCL) || return undef; } my $lock_ret = 0; my $pack; if ($block) { my $flags; fcntl($LOCKFH, F_GETFL, $flags); $flags &amp;= !O_NONBLOCK; my $fail_block = fcntl($LOCKFH, F_SETFL, $flags); print "failed to set the lock to block mode.$!\n" if !$fail_block; } $pack = pack('ssqql', F_WRLCK, SEEK_SET, 0, 0, 0); $lock_ret = fcntl($LOCKFH, F_SETLK, $pack); if (!$lock_ret) { close $LOCKFH; return undef; } return $LOCKFH; } </code></pre>
<p>Try using flock with LOCK_NB, e.g.</p> <pre><code>use Fcntl qw(:DEFAULT :flock); flock( $fh, LOCK_EX|LOCK_NB ) or die "failed to get lock"; ... do code while having the lock ... flock( $fh, LOCK_UN); </code></pre> <p>Apart from that I remember from old times, that locking with NFS was always a bit special and did not always do what you expected. That's why there were special locking schemes using helper files when having mail boxes shared over NFS. I'm not sure if this still applies to current NFS implementations. </p>